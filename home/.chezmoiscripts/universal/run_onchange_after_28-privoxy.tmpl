{{- if (ne .host.distro.family "windows") -}}
#!/usr/bin/env bash

# privoxy config hash: {{ include (joinPath .host.home ".local" "config" "privoxy") | sha256sum }}

{{ includeTemplate "universal/profile" }}
{{ includeTemplate "universal/logg" }}

### Apply system variables
if [ -d /Applications ] && [ -d /System ]; then
    # macOS
    PRIVOXY_CONFIG_DIR=/usr/local/etc/privoxy
else
    # Linux
    PRIVOXY_CONFIG_DIR=/etc/privoxy
fi
PRIVOXY_CONFIG="$PRIVOXY_CONFIG_DIR/config"

### Configure Privoxy
if command -v privoxy > /dev/null; then
    if [ -d  "$PRIVOXY_CONFIG_DIR" ]; then
        sudo cp -f "$HOME/.local/config/privoxy" "$PRIVOXY_CONFIG"
        sudo chmod 600 "$PRIVOXY_CONFIG"

        # Restart / enable Privoxy
        if [ -d /Applications ] && [ -d /System ]; then
            # macOS
            brew services restart privoxy
        else
            # Linux
            sudo systemctl enable privoxy
            sudo systemlctl restart privoxy
        fi
    else
        logg warn 'The '"$PRIVOXY_CONFIG_DIR"' directory is missing'
    fi
else
    logg warn '`privoxy` is missing from the PATH'
fi

{{ end -}}
